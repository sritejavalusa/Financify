@model Financify.Models.ExpenseListViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Your Expenses";
    var labelsJson = JsonSerializer.Serialize(Model.ByCategory.Keys);
    var dataJson = JsonSerializer.Serialize(Model.ByCategory.Values);
}

<style>
    /* ---- Layout tweaks ---- */
    .summary-card {
        background: #fff;
        /* flatter / lighter */
        border: 1px solid #e9ecef;
        /* thinner border */
        box-shadow: none;
        /* no shadow */
    }

    .summary-card .card-body {
        padding: .75rem 1rem;
        /* tighter */
    }

    .summary-chip {
        border-radius: 999px;
        padding: .15rem .6rem;
        font-size: .85rem;
        font-weight: 600;
    }

    /* Chart stands out more */
    .chart-card {
        background: #f6f8fb;
        /* subtle tint */
        border: 1px solid #dfe6f5;
        box-shadow: 0 .25rem .75rem rgba(16, 24, 40, .06);
    }

    .chart-container {
        position: relative;
        height: 380px;
        /* taller chart */
        width: 100%;
    }

    #chartWrap {
        margin-bottom: 1rem;
    }
</style>

<h2 class="mb-3">Your Expenses</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<!-- Filter bar -->
<form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-auto">
        <label class="form-label mb-0">Month</label>
        <select name="month" class="form-select">
            @for (int m = 1; m <= 12; m++)
            {
                <option value="@m" selected="@(m==Model.Month)">@(
                    new DateTime(2000, m, 1).ToString("MMM")
                                )</option>
                        }
        </select>
    </div>
    <div class="col-auto">
        <label class="form-label mb-0">Year</label>
        <input type="number" name="year" class="form-control" value="@Model.Year" />
    </div>
    <div class="col-auto">
        <button class="btn btn-primary">Apply</button>
        <a class="btn btn-outline-secondary"
            href="@Url.Action("ViewExpenses", "Expense", new { month = DateTime.UtcNow.Month, year = DateTime.UtcNow.Year })">
            This Month
        </a>
        <button type="button" id="toggleChart" class="btn btn-outline-primary">Chart View</button>
    </div>
</form>

<!-- Summary (lighter) -->
<div class="card mb-3 summary-card">
    <div class="card-body d-flex flex-wrap gap-3">
        <div><strong>@Model.MonthName</strong></div>
        <div class="text-muted">|</div>
        <div><strong>Total:</strong>
            <span class="@(Model.Total < 0 ? "text-success" : "text-danger")">
                @Model.Total.ToString("C")
            </span>
        </div>
        @foreach (var kv in Model.ByCategory.OrderBy(k => k.Key))
        {
            var good = kv.Value < 0;
            var chipClass = good
            ? "bg-success-subtle text-success"
            : "bg-danger-subtle text-danger";
            <span class="summary-chip @chipClass">
                @kv.Key: @kv.Value.ToString("C")
            </span>
        }
    </div>
</div>

<!-- Chart (more prominent, tinted background) -->
<div id="chartWrap" class="mb-3" style="display:none;">
    <div class="card chart-card">
        <div class="card-container">
            <div class="chart-body">
                <canvas id="catChart"></canvas>
            </div>
        </div>
    </div>
</div>

@if (!Model.Expenses.Any())
{
    <p>No expenses found. Start tracking your expenses!</p>
}
else
{
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th style="width:130px;">Date</th>
                <th>Category</th>
                <th style="width:140px;">Amount</th>
                <th>Notes</th>
                <th style="width:120px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in Model.Expenses)
            {
                string amountClass = e.Amount < 0 ? "text-success fw-semibold" : "text-danger fw-semibold";
                string noteShort = e.Notes?.Length > 40 ? e.Notes.Substring(0, 40) + "…" : e.Notes;

                string BadgeClass(string cat)
                {
                    cat = (cat ?? "").ToLowerInvariant();
                    return cat switch
                    {
                        "food" => "badge bg-success-subtle text-success",
                        "housing" or "rent" => "badge bg-primary-subtle text-primary",
                        "transport" => "badge bg-warning-subtle text-warning text-dark",
                        "entertainment" => "badge bg-info-subtle text-info",
                        "evergy" or "utilities" => "badge bg-secondary-subtle text-secondary",
                        _ => "badge bg-light text-dark"
                    };
                }

                <tr>
                    <td>@e.Date.ToString("dd MMM yyyy")</td>
                    <td><span class="@BadgeClass(e.Category)">@e.Category</span></td>
                    <td class="@amountClass">@e.Amount.ToString("C")</td>
                    <td title="@e.Notes">@noteShort</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <a asp-action="EditExpense" asp-route-id="@e.ExpenseId" class="btn btn-outline-primary"
                                title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form asp-action="Delete" asp-route-id="@e.ExpenseId" method="post"
                                onsubmit="return confirm('Delete this expense?');">
                                <button type="submit" class="btn btn-outline-danger" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<!-- Bootstrap Icons + Chart.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    const labels = @Html.Raw(labelsJson);
    const values = @Html.Raw(dataJson);

    // Hide chart toggle if there’s nothing to plot
    if (!labels || labels.length === 0) {
        document.getElementById('toggleChart')?.classList.add('d-none');
    }

    let chart;
    function buildChart() {
        const ctx = document.getElementById('catChart');
        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Spend by Category (@Model.MonthName)',
                    data: values
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,      // important for fixed-height container
                layout: { padding: 0 },
                animation: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => '$' + Number(ctx.parsed.y).toLocaleString()
                        }
                    }
                },
                scales: {
                    x: { grid: { color: 'rgba(0,0,0,.05)' } },
                    y: {
                        beginAtZero: true,
                        ticks: { callback: (v) => '$' + Number(v).toLocaleString() },
                        grid: { color: 'rgba(0,0,0,.06)' }
                    }
                }
            }
        });
    }

    document.getElementById('toggleChart').addEventListener('click', () => {
        const wrap = document.getElementById('chartWrap');
        const show = wrap.style.display === 'none';
        wrap.style.display = show ? '' : 'none';
        if (show && labels.length) buildChart();
    });
</script>